<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Medical News Feed</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial,
          sans-serif;
        margin: 0;
        background: #f7f7f8;
        color: #222;
      }
      header {
        background: #0b6efd;
        color: #fff;
        padding: 16px;
      }
      header h1 {
        margin: 0;
        font-size: 20px;
      }
      .container {
        max-width: 1000px;
        margin: 20px auto;
        padding: 0 16px;
      }
      .controls {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 12px;
      }
      input,
      select,
      button {
        padding: 8px;
        font-size: 14px;
      }
      .export-btn {
        background: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .export-btn:hover {
        background: #218838;
      }
      .export-btn.pdf {
        background: #dc3545;
      }
      .export-btn.pdf:hover {
        background: #c82333;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 12px;
      }
      .card {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        padding: 12px;
        display: flex;
        flex-direction: column;
      }
      .card h3 {
        margin: 0 0 6px;
        font-size: 16px;
      }
      .card p {
        margin: 0 0 8px;
        color: #555;
        font-size: 13px;
      }
      .meta {
        font-size: 12px;
        color: #666;
        margin-top: auto;
      }
      .image {
        width: 100%;
        height: 140px;
        object-fit: cover;
        border-radius: 6px;
        margin-bottom: 8px;
        background: #eee;
      }
      footer {
        text-align: center;
        margin: 24px 0;
        color: #666;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="container">
        <h1>Medical News Feed</h1>
      </div>
    </header>
    <div class="container">
      <div class="controls">
        <select id="site" title="Filter by site"></select>
        <input id="q" placeholder="Search keywords (e.g. cancer)" />
        <input id="limit" type="number" min="1" max="500" value="50" title="Number of articles" />
        <button type="button" id="refresh">Refresh</button>
        <button type="button" id="exportWord" class="export-btn">Export Word</button>
        <button type="button" id="exportPdf" class="export-btn pdf">Export PDF</button>
      </div>
      <div id="status" style="margin-bottom: 8px; font-size: 12px; color: #666"></div>
      <div class="grid" id="grid"></div>
    </div>
    <footer>Built with FastAPI · Feeds are refreshed periodically</footer>

    <script>
      async function loadSites() {
        const res = await fetch('/sites');
        const sites = await res.json();
        const sel = document.getElementById('site');
        sel.innerHTML =
          '<option value="">All Sites</option>' + sites.map(s => `<option>${s}</option>`).join('');
      }

      function esc(s) {
        return (s || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      }

      async function loadArticles() {
        const site = document.getElementById('site').value;
        const q = document.getElementById('q').value;
        const limit = document.getElementById('limit').value || 50;
        const params = new URLSearchParams();
        if (site) params.set('site', site);
        if (q) params.set('q', q);
        if (limit) params.set('limit', limit);
        const res = await fetch('/articles?' + params.toString());
        const data = await res.json();
        const grid = document.getElementById('grid');
        const status = document.getElementById('status');
        const last = new Date((data.last_refresh || 0) * 1000).toLocaleString();
        status.textContent = `Showing ${data.count} articles · Last refresh: ${last}`;
        grid.innerHTML = data.articles
          .map(
            a => `
    <div class="card">
      ${a.image ? `<img class="image" src="${esc(a.image)}" alt="">` : ''}
      <h3><a href="${esc(a.link)}" target="_blank" rel="noopener noreferrer">${esc(
              a.title
            )}</a></h3>
      ${a.summary ? `<p>${esc(a.summary)}</p>` : ''}
      <div class="meta">${esc(a.site || a.source || '')}</div>
    </div>
  `
          )
          .join('');
      }

      window.addEventListener('DOMContentLoaded', async () => {
        await loadSites();
        await loadArticles();
        document.getElementById('site').addEventListener('change', loadArticles);
        document.getElementById('q').addEventListener('input', () => {
          clearTimeout(window._t);
          window._t = setTimeout(loadArticles, 400);
        });
        document.getElementById('limit').addEventListener('change', loadArticles);
        document.getElementById('refresh').addEventListener('click', loadArticles);

        document.getElementById('exportWord').addEventListener('click', () => {
          const params = new URLSearchParams();
          const site = document.getElementById('site').value;
          const q = document.getElementById('q').value;
          const limit = document.getElementById('limit').value || 50;
          if (site) params.set('site', site);
          if (q) params.set('q', q);
          if (limit) params.set('limit', limit);
          window.location.href = '/export/word?' + params.toString();
        });

        document.getElementById('exportPdf').addEventListener('click', () => {
          const params = new URLSearchParams();
          const site = document.getElementById('site').value;
          const q = document.getElementById('q').value;
          const limit = document.getElementById('limit').value || 50;
          if (site) params.set('site', site);
          if (q) params.set('q', q);
          if (limit) params.set('limit', limit);
          window.location.href = '/export/pdf?' + params.toString();
        });
      });
    </script>
  </body>
</html>
